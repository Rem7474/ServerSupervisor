# SystÃ¨me de DÃ©tection et Affichage des CVE

## ğŸ“‹ Vue d'ensemble

Le systÃ¨me de monitoring ServerSupervisor inclut maintenant la **dÃ©tection automatique des CVE** (Common Vulnerabilities and Exposures) pour les paquets APT en attente de mise Ã  jour.

## ğŸ¯ FonctionnalitÃ©s

### 1. **DÃ©tection automatique des CVE**
- Extraction des CVE depuis les changelogs APT
- DÃ©tection de la criticitÃ© (CRITICAL, HIGH, MEDIUM, LOW, NEGLIGIBLE)
- Association CVE â†” Package

### 2. **Affichage de la criticitÃ© maximale**
- Badge colorÃ© indiquant la criticitÃ© max par hÃ´te
- PrioritÃ© visuelle : CRITICAL (rouge) â†’ HIGH (orange) â†’ MEDIUM (jaune) â†’ LOW (bleu)
- Compteur de CVE total

### 3. **
 cliquables**
- Chaque CVE est un lien vers https://ubuntu.com/security/CVE-XXXX-YYYY
- IcÃ´ne externe pour indiquer le lien
- Tooltip avec dÃ©tails (ID, criticitÃ©, package)

### 4. **Interface utilisateur**
- **Dashboard** : Colonne "CVE Max" montrant la criticitÃ© la plus haute
- **Page APT** : Liste complÃ¨te des CVE avec expansion/collapse
- **Page HÃ´te** : DÃ©tails des CVE pour cet hÃ´te spÃ©cifique

## ğŸ“¦ Architecture

### Agent (Go)
```
agent/internal/collector/apt.go
â”œâ”€â”€ CVEInfo struct (ID, Severity, Package)
â”œâ”€â”€ extractCVEsForPackage() - Extraction depuis changelog
â”œâ”€â”€ extractCVEsFromPolicy() - Fallback si changelog Ã©choue
â””â”€â”€ detectSeverityFromChangelog() - InfÃ©rence de criticitÃ©
```

### Backend (Go + PostgreSQL)
```
server/internal/models/models.go
â”œâ”€â”€ CVEInfo struct
â””â”€â”€ AptStatus.CVEList (JSON)

server/internal/database/db.go
â”œâ”€â”€ apt_status.cve_list (TEXT, JSON)
â””â”€â”€ UpsertAptStatus() - Stockage CVE
```

### Frontend (Vue.js)
```
frontend/src/components/
â”œâ”€â”€ CVEBadge.vue - Badge individuel avec lien
â””â”€â”€ CVEList.vue - Liste avec criticitÃ© max

frontend/src/views/
â”œâ”€â”€ DashboardView.vue - Colonne CVE Max
â”œâ”€â”€ AptView.vue - DÃ©tails CVE par hÃ´te
â””â”€â”€ HostDetailView.vue - CVE de l'hÃ´te
```

## ğŸš€ Installation

### Migration automatique

La migration de base de donnÃ©es pour le support CVE est **automatique** lors du dÃ©marrage du conteneur PostgreSQL grÃ¢ce au script `docker-init.sh`.

### DÃ©ploiement

**1. Rebuilder les containers Docker:**
```bash
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

**2. RedÃ©marrer les agents:**

Sur chaque serveur monitorÃ©:
```bash
sudo systemctl restart serversupervisor-agent
```

La colonne `cve_list` sera automatiquement crÃ©Ã©e au premier dÃ©marrage de PostgreSQL.

## ğŸ“Š Format des donnÃ©es

### Structure JSON des CVE
```json
[
  {
    "id": "CVE-2024-1234",
    "severity": "CRITICAL",
    "package": "openssl"
  },
  {
    "id": "CVE-2024-5678",
    "severity": "HIGH",
    "package": "nginx"
  }
]
```

### Niveaux de sÃ©vÃ©ritÃ©
| Severity | Couleur | Badge | Action |
|----------|---------|-------|--------|
| **CRITICAL** | ğŸ”´ Rouge | `bg-red` | **Upgrade immÃ©diat requis** |
| **HIGH** | ğŸŸ  Orange | `bg-orange` | Upgrade urgent |
| **MEDIUM** | ğŸŸ¡ Jaune | `bg-yellow` | Upgrade recommandÃ© |
| **LOW** | ğŸ”µ Bleu | `bg-blue-lt` | Upgrade planifiÃ© |
| **NEGLIGIBLE** | âšª Gris | `bg-secondary-lt` | Optionnel |

## ğŸ” MÃ©thodes de dÃ©tection

### 1. **Changelog APT** (MÃ©thode principale)
```bash
apt-get changelog <package>
```
- Parse les entrÃ©es changelog pour trouver les patterns `CVE-YYYY-NNNNN`
- Extrait la sÃ©vÃ©ritÃ© depuis les USN (Ubuntu Security Notices)
- Timeout de 10s par package

### 2. **Policy APT** (Fallback)
```bash
apt-cache policy <package>
```
- VÃ©rifie si le package vient du repository `-security`
- CriticitÃ© par dÃ©faut: MEDIUM
- Plus rapide mais moins prÃ©cis

### 3. **InfÃ©rence contextuelle**
Si la sÃ©vÃ©ritÃ© n'est pas trouvÃ©e, analyse du contexte :
- "remote code execution" â†’ CRITICAL
- "privilege escalation" â†’ CRITICAL
- "denial of service" â†’ MEDIUM
- "information disclosure" â†’ MEDIUM

## ğŸ¨ Composants Vue

### `<CVEBadge>`
Badge individuel pour une CVE avec lien cliquable.

**Props:**
- `cve` (Object) - {id, severity, package}
- `showIcon` (Boolean) - Afficher l'icÃ´ne de lien externe

**Exemple:**
```vue
<CVEBadge :cve="{ id: 'CVE-2024-1234', severity: 'CRITICAL', package: 'openssl' }" />
```

### `<CVEList>`
Liste de CVE avec criticitÃ© maximale et expansion.

**Props:**
- `cveList` (String|Array) - JSON string ou tableau de CVE
- `showMaxSeverity` (Boolean) - Afficher le badge de criticitÃ© max
- `alwaysExpanded` (Boolean) - Toujours afficher la liste
- `limit` (Number) - Nombre de CVE avant "plus..."

**Exemple:**
```vue
<CVEList 
  :cveList="aptStatus.cve_list" 
  :showMaxSeverity="true"
  :limit="5"
/>
```

## ğŸ“ˆ Performance

### ConsidÃ©rations
- **Timeout changelog** : 10s par package (Ã©vite blocage sur packages lents)
- **Cache** : Les CVE sont stockÃ©s en base, pas de re-fetch Ã  chaque affichage
- **JSON parsing** : CÃ´tÃ© frontend uniquement, backend stocke en TEXT
- **Batch processing** : L'agent collecte les CVE pendant le rapport APT (toutes les 30s)

### Optimisations
- Changel est tÃ©lÃ©chargÃ© uniquement pour les packages `-security`
- Fallback sur `apt-cache policy` si changelog Ã©choue
- DÃ©doublonnage des CVE (plusieurs packages peuvent avoir la mÃªme CVE)

## ğŸ”— Liens utiles

- **Ubuntu CVE Database**: https://ubuntu.com/security/cves
- **NIST CVE Database**: https://nvd.nist.gov/vuln/search
- **CVE Details**: https://www.cvedetails.com/

## ğŸ› Debugging

### VÃ©rifier que la migration a Ã©tÃ© appliquÃ©e
```bash
docker exec -it <postgres_container> psql -U serversupervisor -d serversupervisor -c "\d apt_status"
# Devrait afficher la colonne cve_list
```

### VÃ©rifier les CVE en base
```sql
docker exec -it <postgres_container> psql -U serversupervisor -d serversupervisor -c "SELECT host_id, security_updates, LENGTH(cve_list) as cve_length FROM apt_status WHERE security_updates > 0;"
```

### Logs agent (CVE extraction)
```bash
journalctl -u serversupervisor-agent -f | grep CVE
```

### Tester extraction manuelle
```bash
# Sur un serveur avec l'agent
apt-get changelog openssl | grep -i cve
```

## ğŸ“ Notes

- **Packages sans CVE explicite** : Si un package de sÃ©curitÃ© n'a pas de CVE listÃ©e dans le changelog, un marqueur `SECURITY-UPDATE` est utilisÃ©
- **CriticitÃ© UNKNOWN** : Quand la sÃ©vÃ©ritÃ© ne peut Ãªtre dÃ©terminÃ©e, `MEDIUM` est utilisÃ© par dÃ©faut
- **Multi-CVE** : Un seul package peut corriger plusieurs CVE (toutes sont listÃ©es)

## ğŸ”„ Mise Ã  jour automatique

Les CVE sont automatiquement mis Ã  jour :
1. L'agent collecte l'Ã©tat APT toutes les **30 secondes** (configurable via `report_interval`)
2. Si de nouveaux packages de sÃ©curitÃ© sont dÃ©tectÃ©s, les CVE sont extraites
3. Le backend stocke les CVE en JSON
4. Le frontend affiche les CVE via WebSocket en **temps rÃ©el**

## âš ï¸ Limitations

1. **NÃ©cessite APT** : Fonctionne uniquement sur Debian/Ubuntu
2. **Changelog accessible** : Certains packages peuvent ne pas avoir de changelog accessible
3. **SÃ©vÃ©ritÃ© approximative** : L'infÃ©rence de sÃ©vÃ©ritÃ© depuis le changelog peut Ãªtre imprÃ©cise
4. **Performance** : L'extraction de CVE pour de nombreux packages peut prendre du temps (timeout 10s/package)

## ğŸ¯ Prochaines amÃ©liorations possibles

- [ ] IntÃ©gration avec API Ubuntu Security (https://security-metadata.canonical.com/)
- [ ] Cache des CVE pour Ã©viter de re-parser les changelogs
- [ ] Notifications push pour CVE CRITICAL
- [ ] Graphique historique des CVE resolues
- [ ] Export CSV/PDF des rapports CVE
- [ ] Filtrage par criticitÃ© dans le dashboard
