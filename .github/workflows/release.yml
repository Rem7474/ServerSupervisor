name: Release

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'   # pre-releases: v1.2.3-beta.1

permissions:
  contents: write       # crÃ©er la GitHub Release et uploader les assets
  packages: write       # pousser sur ghcr.io

env:
  REGISTRY: ghcr.io
  SERVER_IMAGE: ghcr.io/${{ github.repository_owner }}/serversupervisor

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Extraction des mÃ©tadonnÃ©es de version
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  meta:
    name: Version metadata
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      is_prerelease: ${{ steps.meta.outputs.is_prerelease }}
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0   # nÃ©cessaire pour git log

      - name: Extract version info
        id: meta
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          if [[ "$TAG" =~ - ]]; then
            echo "is_prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate changelog from commits
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            RANGE="${PREV_TAG}..HEAD"
          else
            RANGE="HEAD"
          fi

          # GÃ©nÃ©rer changelog groupÃ© par type (feat, fix, etc.)
          CHANGELOG=""

          # Features
          FEATURES=$(git log "$RANGE" --pretty=format:"- %s (%h)" --no-merges --grep="^feat" | head -20)
          if [ -n "$FEATURES" ]; then
            CHANGELOG="${CHANGELOG}### âœ¨ Features\n${FEATURES}\n"
          fi

          # Fixes
          FIXES=$(git log "$RANGE" --pretty=format:"- %s (%h)" --no-merges --grep="^fix" | head -20)
          if [ -n "$FIXES" ]; then
            CHANGELOG="${CHANGELOG}### ğŸ› Bug Fixes\n${FIXES}\n"
          fi

          # Other changes
          OTHERS=$(git log "$RANGE" --pretty=format:"- %s (%h)" --no-merges --grep="^chore\|^refactor\|^perf" | head -10)
          if [ -n "$OTHERS" ]; then
            CHANGELOG="${CHANGELOG}### ğŸ”§ Other Changes\n${OTHERS}\n"
          fi

          # Nettoyer le changelog : supprimer les \n en trop en fin de chaÃ®ne
          CHANGELOG=$(printf "%s" "$CHANGELOG" | sed ':a;N;$!ba;s/\n\{2,\}/\n/g')

          # Ã‰chapper les caractÃ¨res spÃ©ciaux pour GitHub Actions (remplacer \n par %0A, \r par %0D, % par %25)
          SAFE_CHANGELOG=$(printf "%s" "$CHANGELOG" | sed -e 's/%/%25/g' -e 's/\r/%0D/g' -e 's/\n/%0A/g')
          echo "changelog=$SAFE_CHANGELOG" >> "$GITHUB_OUTPUT"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Binaires agent multi-plateforme
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  agent-binaries:
    name: Agent binaries
    runs-on: ubuntu-latest
    needs: meta

    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
          - goos: linux
            goarch: arm
            goarm: "7"
            suffix: linux-armv7
          - goos: linux
            goarch: arm
            goarm: "6"
            suffix: linux-armv6

    steps:
      - uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: agent/go.mod
          cache-dependency-path: agent/go.sum

      - name: Build agent binary
        working-directory: agent
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          CGO_ENABLED: "0"
        run: |
          VERSION="${{ needs.meta.outputs.version }}"
          go build \
            -ldflags="-s -w -X main.Version=${VERSION}" \
            -o "agent-${{ matrix.suffix }}" \
            ./cmd/agent

      - name: Compress binary
        working-directory: agent
        run: |
          gzip -k "agent-${{ matrix.suffix }}"
          sha256sum "agent-${{ matrix.suffix }}.gz" > "agent-${{ matrix.suffix }}.gz.sha256"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v7
        with:
          name: agent-${{ matrix.suffix }}
          path: |
            agent/agent-${{ matrix.suffix }}.gz
            agent/agent-${{ matrix.suffix }}.gz.sha256
          retention-days: 1

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Image Docker serveur multi-arch (amd64 + arm64)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  docker-server:
    name: Docker server image
    runs-on: ubuntu-latest
    needs: meta

    steps:
      - uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: docker-meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.SERVER_IMAGE }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable=${{ needs.meta.outputs.is_prerelease == 'false' }}

      - name: Build and push server image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: server/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.docker-meta.outputs.tags }}
          labels: ${{ steps.docker-meta.outputs.labels }}
          build-args: |
            VERSION=${{ needs.meta.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # GitHub Release avec tous les assets
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [meta, agent-binaries, docker-server]

    steps:
      - name: Download all agent binaries
        uses: actions/download-artifact@v8
        with:
          pattern: agent-*
          path: ./release-assets
          merge-multiple: true

      - name: List release assets
        run: ls -lh ./release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "ServerSupervisor v${{ needs.meta.outputs.version }}"
          prerelease: ${{ needs.meta.outputs.is_prerelease == 'true' }}
          generate_release_notes: false
          body: |
            ## ServerSupervisor v${{ needs.meta.outputs.version }}

            ### ğŸ³ Image Docker

            **Serveur** (inclut frontend intÃ©grÃ©) :
            ```bash
            docker pull ${{ env.SERVER_IMAGE }}:${{ needs.meta.outputs.version }}
            ```

            ### ğŸ“¦ Binaires agent

            L'agent doit tourner **nativement** sur le systÃ¨me supervisÃ© (accÃ¨s Ã  `docker`, `apt`, etc.).

            | Plateforme | Fichier |
            |-----------|---------|
            | Linux x86_64 | `agent-linux-amd64.gz` |
            | Linux ARM 64-bit | `agent-linux-arm64.gz` |
            | Linux ARM 32-bit v7 (Raspberry Pi) | `agent-linux-armv7.gz` |
            | Linux ARM 32-bit v6 | `agent-linux-armv6.gz` |

            **Installation rapide :**
            ```bash
            # Remplacer ARCH par: amd64, arm64, armv7, armv6
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/agent-linux-ARCH.gz | \
              gunzip > /usr/local/bin/serversupervisor-agent
            chmod +x /usr/local/bin/serversupervisor-agent
            ```

            **VÃ©rifier l'intÃ©gritÃ© :**
            ```bash
            sha256sum -c agent-linux-ARCH.gz.sha256
            ```

            ### ğŸ“ Changelog

            ${{ needs.meta.outputs.changelog }}
          files: |
            ./release-assets/*.gz
            ./release-assets/*.sha256
