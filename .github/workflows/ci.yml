name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─────────────────────────────────────────
  # Serveur Go
  # ─────────────────────────────────────────
  server:
    name: Server (Go)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: server/go.mod
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify go.mod is tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum || {
            echo "::error::go.mod or go.sum is not tidy. Run 'go mod tidy' locally."
            exit 1
          }

      - name: go vet
        run: go vet ./...

      - name: Build
        run: CGO_ENABLED=0 go build -ldflags="-s -w" -o /tmp/serversupervisor ./cmd/server

      - name: Run tests
        run: go test -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: server-coverage
          path: server/coverage.out
          retention-days: 7

  # ─────────────────────────────────────────
  # Agent Go
  # ─────────────────────────────────────────
  agent:
    name: Agent (Go)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: agent

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: agent/go.mod
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Verify go.mod is tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum || {
            echo "::error::go.mod or go.sum is not tidy. Run 'go mod tidy' locally."
            exit 1
          }

      - name: go vet
        run: go vet ./...

      - name: Build (linux/amd64)
        run: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o /tmp/agent-linux-amd64 ./cmd/agent

      - name: Build (linux/arm64)
        run: CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o /tmp/agent-linux-arm64 ./cmd/agent

      - name: Build (linux/arm/v7)
        run: CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=7 go build -ldflags="-s -w" -o /tmp/agent-linux-armv7 ./cmd/agent

      - name: Run tests
        run: go test -race ./...

  # ─────────────────────────────────────────
  # Frontend Vue 3 / Vite
  # ─────────────────────────────────────────
  frontend:
    name: Frontend (Vue 3)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm install --prefer-offline --no-audit

      - name: Build
        run: npm run build

      - name: Check for console.log in production code
        run: |
          FOUND=$(grep -r "console\.log" src/ --include="*.vue" --include="*.js" \
            --exclude-dir=node_modules -l 2>/dev/null || true)
          if [ -n "$FOUND" ]; then
            echo "::warning::console.log found in production code:"
            echo "$FOUND"
          fi

      - name: Upload build artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 7

  # ─────────────────────────────────────────
  # Docker build smoke test (pas de push)
  # ─────────────────────────────────────────
  docker-build:
    name: Docker build (smoke test)
    runs-on: ubuntu-latest
    needs: [server, frontend]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build server image (no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: server/Dockerfile
          push: false
          tags: serversupervisor/server:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build agent image (no push)
        uses: docker/build-push-action@v5
        with:
          context: agent
          file: agent/Dockerfile
          push: false
          tags: serversupervisor/agent:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max
